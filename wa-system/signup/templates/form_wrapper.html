{$class_id = 'wa-signup-form-wrapper'}
{$wrapper_id = uniqid($class_id)}

{* PREPARE CLASS STRING FOR WRAPPER *}
{$_classes = [$class_id]}
{if $is_onetime_password_auth_type}
    {$_classes[] = 'wa-is-onetime-password-auth-type'}
{/if}
{if $is_need_confirm}
    {$_classes[] = 'wa-is-need-confirm'}
{/if}
{$_classes = $_classes|join:" "}

{$_timeout = intval($timeout|default:0)}
{if $_timeout <= 0}{$_timeout = 60}{/if}

{$_locale = [
    'required' => '[s`Field is required`]',
    'onetime_password_required' => '[`Enter a confirmation code to complete signup`]',
    'confirmation_code_required' => '[`Enter a confirmation code to complete signup`]'
]}

<div class="{$_classes}" id="{$wrapper_id}" style="visibility: hidden;">

    {* SIGN UP FORM ITSELF *}
    {$form}

    <script>
        ( function($) { "use strict";
            load([
                {
                    id: "wa-content-signup-css",
                    type: "css",
                    uri: "{$wa_url}wa-content/css/signup/signup.css?v={$wa->version()}"
                },
                {
                    id: "wa-content-signup-js",
                    type: "js",
                    uri: "{$wa_url}wa-content/js/signup/signup.js?v={$wa->version()}"
                }
            ]).then(init);

            function load(sources) {
                var deferred = $.Deferred();

                loader(sources).then( function() {
                    deferred.resolve();
                });

                return deferred.promise();

                function loader(sources) {
                    var deferred = $.Deferred(),
                        counter = sources.length;

                    $.each(sources, function(i, source) {
                        switch (source.type) {
                            case "css":
                                loadCSS(source);
                                break;
                            case "js":
                                loadJS(source);
                                break;
                        }
                    });

                    return deferred.promise();

                    //

                    function loadCSS(source) {
                        var $link = $("#" + source.id);
                        if ($link.length) {
                            $link.data("promise").then(onLoad);

                        } else {
                            var deferred = $.Deferred(),
                                promise = deferred.promise();

                            $link = $("<link />", {
                                id: source.id,
                                rel: "stylesheet"
                            }).appendTo("head")
                                .data("promise", promise);

                            $link.on("load", function() {
                                onLoad();
                                deferred.resolve();
                            });

                            $link.attr("href", source.uri);
                        }

                        function onLoad() {
                            counter -= 1;
                            watcher();
                        }
                    }

                    function loadJS(source) {
                        var $script = $("#" + source.id);
                        if ($script.length) {
                            $script.data("promise").then(onLoad);

                        } else {
                            var deferred = $.Deferred(),
                                promise = deferred.promise(),
                                script = document.createElement("script");

                            $script = $(script)
                                .attr("id", source.id)
                                .appendTo("head")
                                .data("promise", promise);

                            $script.on("load", function () {
                                onLoad();
                                deferred.resolve();
                            });

                            $script.attr("src", source.uri);
                        }

                        function onLoad() {
                            counter -= 1;
                            watcher();
                        }
                    }

                    function watcher() {
                        if (counter === 0) {
                            deferred.resolve();
                        }
                    }
                }
            }

            function init() {
                new WaSignup({
                    $wrapper: $("#{$wrapper_id}").removeAttr("style"),
                    namespace: {$namespace|json_encode},
                    locale: {$_locale|json_encode},
                    timeout: {$_timeout|json_encode},
                    url: {$url|json_encode},
                    is_onetime_password_auth_type: {$is_onetime_password_auth_type|json_encode},
                    is_need_confirm: {$is_need_confirm|json_encode},
                    need_redirects: {$need_redirects|default:''|json_encode},
                    auth_after_link_sent: {$auth_after_link_sent|default:false|json_encode}
                });
            }
        })(jQuery);
    </script>
</div>
